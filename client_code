// client code

#include <BLEDevice.h>
#include <BLEUtils.h>
#include <BLEScan.h>
#include <BLEAdvertisedDevice.h>

BLEScan* pBLEScan;
float lastDistance = 0;
String targetDeviceName = "BLE_Server"; // ì„œë²„ ESP32 ì´ë¦„

bool serverConnected = false;
bool wasPreviouslyConnected = false;

void setup() {
  Serial.begin(115200);
  BLEDevice::init("");
  pBLEScan = BLEDevice::getScan();
  pBLEScan->setActiveScan(true);
  Serial.println("ğŸ“¡ BLE ê±°ë¦¬ ì¸¡ì • í´ë¼ì´ì–¸íŠ¸ ì‹œì‘");
}

void loop() {
  BLEScanResults* foundDevices = pBLEScan->start(1, false);
  serverConnected = false;

  for (int i = 0; i < foundDevices->getCount(); ++i) {
    BLEAdvertisedDevice device = foundDevices->getDevice(i);
    if (device.getName() == targetDeviceName) {
      serverConnected = true;

      if (!wasPreviouslyConnected) {
        Serial.println("âœ… BLE ì„œë²„ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ê±°ë¦¬ ì¸¡ì • ì‹œì‘...");
        wasPreviouslyConnected = true;
      }

      int rssi = device.getRSSI();
      float txPower = -70.0;
      float n = 2.7;

      lastDistance = pow(10.0, (txPower - rssi) / (10 * n));

      Serial.print("ğŸ“¶ RSSI: ");
      Serial.print(rssi);
      Serial.print(" dBm â†’ ğŸ“ ê±°ë¦¬ ì¶”ì •: ");
      Serial.print(lastDistance, 2);
      Serial.println(" m");
      break;
    }
  }

  pBLEScan->clearResults();

  // ë§Œì•½ ì´ë²ˆì—” ê°ì§€ ì•ˆ ëê³ , ì´ì „ì—ëŠ” ì—°ê²°ë˜ì–´ ìˆì—ˆë‹¤ë©´
  if (!serverConnected && wasPreviouslyConnected) {
    Serial.println("âŒ BLE ì„œë²„ê°€ ë” ì´ìƒ ê°ì§€ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì¸¡ì • ì¤‘ë‹¨.");
    wasPreviouslyConnected = false;
  }

  delay(1000);
}
